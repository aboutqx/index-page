<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="../css/normalize.css" rel="stylesheet" type="text/css">
  <style>
  *{
    box-sizing:border-box;
  }
  .workarea{
    display: flex;
  }
  .container{
    max-width: 1024px;
    margin: 0 auto;
  }
  .img-wrapper{
    margin: 30px 30px 0 10px;
    width:400px;
    height:300px;
    overflow: auto;
    box-shadow: 0 1px 3px 0 rgba(0,0,0,.2),0 1px 1px 0 rgba(0,0,0,.14),0 2px 1px -1px rgba(0,0,0,.12);
    border: 1px dashed #ccc;
    text-align: center;
    outline: 0;
  }
  .info{
    position: absolute;
    font-size: 16px;
    color: #d11;
    top:5px;
  }
  .img-wrapper img{
    
    display: none;
  }
  .result.img-wrapper img{
    display: block;
    width:100%;
  }
  .img-wrapper canvas{
    width:100%;
  }
  input[type=text]{
    
    padding: 8px;
    border-bottom: solid 2px #c9c9c9;
    box-shadow: 0 0 6px #cdd2d4;
    transition: border 0.3s;
  }
  input[type=text]:hover{
    border-color: #a5acb0;
    border-bottom: solid 2px #969696;
  }
  .interval{
    margin: 20px 0 0 10px;
    font-size: 16px;
  }
  .dragovered{
    box-shadow: 0 0 10px #d11;
  }
  button,input[type=text]{
    border:none;
    outline: none;
  }
  button{
    box-shadow: 0 2px 5px 0 rgba(0,0,0,.26);
    min-width: 88px;
    min-height: 28px;
    line-height: 28px;
    font-size: 16px;
    padding: 2px;
    font-family: 'Microsoft Yahei';
    margin: 0 0 0 5px;
  }
  button[disabled]{
    background-color: rgba(0,0,0,0.12);
  }
  button:not([disabled]):active{
    background-color: #ccc;
  }
  .tip{
    line-height: 290px;
  }
  </style>
</head>
<body>
  <div class="container">
  <div class="workarea">
    <span class="info"></span>
    <div class="img-wrapper" >
      <span class="tip">拖放图片到此处</span>
    </div>
    <div class="img-wrapper" >
      <span class="tip">拖放图片到此处</span>
    </div>
  </div>
    <input type="text" class="interval" placeholder=0>
    <button class="go">go</button>
    <button class="clear">clear</button>
    <div class="result img-wrapper"><img></div>
  </div>
  <script src="../js/jquery-1.9.1.js"></script>
  <script src="vendor/gif.js"></script>
  <script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?14477adbfac6547eb550adaea5cc3d48";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
  
  var m=document.querySelector('.info');
  var imgWrapper=$('.img-wrapper');

  /* Drag drop stuff */
  imgWrapper.each(function(){

    $(this).on('dragover',function(e){
      e.preventDefault();
      $(this).addClass('dragovered');
    });
    $(this).on('dragleave',function(e){
      e.preventDefault();
      $(this).removeClass('dragovered');
    });
    $(this).on('drop', function(e){     
      e.preventDefault();
      $(this).removeClass('dragovered');
      if($(this).hasClass('result')) return;
      e=e.originalEvent;
      var length = e.dataTransfer.items.length;
      if(length > 1){
        m.innerHTML = "请只放入一个文件";
      } else {
        process(e.dataTransfer.files[0],this);
      }
    });

  });
  window.ondragover=function(e){
    e.preventDefault();
  };
  window.ondrop=function(e){
    e.preventDefault();
  };
  var aniInterval,renderWidth=0,renderHeight=0;
  function process(file,that){
      var fileURL = URL.createObjectURL(file);
      if(file.type.match(/image\/*/)){
        var img=$(that).find('img')[0]||new Image();
        var canvas=$(that).find('canvas')[0]||document.createElement('canvas');
        img.src = fileURL;

        canvas.setAttribute('draggable',false);
        that.appendChild(canvas);
        img.onload=function(){

          renderWidth=renderWidth==0?img.naturalWidth:(renderWidth>=img.naturalWidth?img.naturalWidth:renderWidth);
          renderHeight=renderHeight==0?img.naturalHeight:(renderHeight>=img.naturalHeight?img.naturalHeight:renderHeight);
          canvas.width=renderWidth;
          canvas.height=renderHeight;
          var ctx=canvas.getContext('2d');
          ctx.drawImage(img,0,0);
          addEvent(canvas);
        }

        that.children[0].style.display='none';
      } else{
        m.innerHTML='文件类型错误，请拖入拖入图片'
      }
      
  }
  function addEvent(canvas){
    var ctx=canvas.getContext('2d');
    ctx.strokeStyle='lightblue';
    ctx.lineWidth=5;

    var mousedown=false,wScale=canvas.width/parseInt(getComputedStyle(canvas,'').getPropertyValue('width')),hScale=canvas.height/parseInt(getComputedStyle(canvas,'').getPropertyValue('height'));
    var offsetW=canvas.offsetLeft,offsetH=canvas.offsetTop;
    canvas.addEventListener('mousedown',function(e){
      mousedown=true;
      ctx.beginPath();
      ctx.moveTo((e.clientX-offsetW)*wScale,(e.clientY-offsetH)*hScale);
    });
    canvas.addEventListener('mousemove',function(e){
      if(!mousedown) return;
      ctx.lineTo((e.clientX-offsetW)*wScale,(e.clientY-offsetH)*hScale);
      ctx.stroke();
    });
    document.addEventListener('mouseup',function(e){
      mousedown=false;
    })
  }
//https://github.com/jnordberg/gif.js
  $('.go').on('click',function(){
    if(!imgWrapper.find('canvas')[0]||!imgWrapper.eq(1).find('canvas')[0]) return;

    $(this).attr('disabled',true);
    var tmp=parseInt($('.interval').val());
    aniInterval=tmp<0?0:tmp;
    var gif = new GIF({
      workers: 2,
      quality: 10,
      width:renderWidth,
      height:renderHeight
    });
    gif.addFrame(imgWrapper.find('canvas')[0]);

    // or a canvas element
    gif.addFrame(imgWrapper.eq(1).find('canvas')[0], {delay: aniInterval});
    $('.result img').remove();
    gif.on('finished', function(blob) {
      $('.result').append('<img>');
      $('.result img').attr('src',URL.createObjectURL(blob));
      $('.go').attr('disabled',false);
    });

    gif.render();
  });
  $('.clear').on('click',function(){
    $('.result img').remove();

  });
  </script>
</body>
</html>